{
  "Comment": "HourStats Bluesky Bot Workflow - Sequential Dynamic Fetching with Internal Loops",
  "StartAt": "Start",
  "States": {
    "Start": {
      "Type": "Task",
      "Resource": "arn:aws:lambda:${aws_region}:${aws_account_id}:function:hourstats-orchestrator",
      "Parameters": {
        "action": "startWorkflow",
        "analysisIntervalMinutes": 60
      },
      "ResultPath": "$.OrchestratorOutput",
      "Next": "FetchBatch1"
    },
    "FetchBatch1": {
      "Type": "Task",
      "Resource": "arn:aws:lambda:${aws_region}:${aws_account_id}:function:hourstats-fetcher",
      "Parameters": {
        "runId.$": "$.OrchestratorOutput.runId",
        "analysisIntervalMinutes": 60,
        "batchId": "batch-1",
        "maxIterations": 30
      },
      "ResultPath": "$.FetcherOutput1",
      "Next": "CheckContinue1"
    },
    "CheckContinue1": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.FetcherOutput1.hasMorePosts",
          "BooleanEquals": true,
          "Next": "FetchBatch2"
        }
      ],
      "Default": "ProcessPosts"
    },
    "FetchBatch2": {
      "Type": "Task",
      "Resource": "arn:aws:lambda:${aws_region}:${aws_account_id}:function:hourstats-fetcher",
      "Parameters": {
        "runId.$": "$.OrchestratorOutput.runId",
        "analysisIntervalMinutes": 60,
        "batchId": "batch-2",
        "maxIterations": 30
      },
      "ResultPath": "$.FetcherOutput2",
      "Next": "CheckContinue2"
    },
    "CheckContinue2": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.FetcherOutput2.hasMorePosts",
          "BooleanEquals": true,
          "Next": "FetchBatch3"
        }
      ],
      "Default": "ProcessPosts"
    },
    "FetchBatch3": {
      "Type": "Task",
      "Resource": "arn:aws:lambda:${aws_region}:${aws_account_id}:function:hourstats-fetcher",
      "Parameters": {
        "runId.$": "$.OrchestratorOutput.runId",
        "analysisIntervalMinutes": 60,
        "batchId": "batch-3",
        "maxIterations": 30
      },
      "ResultPath": "$.FetcherOutput3",
      "Next": "ProcessPosts"
    },
    "ProcessPosts": {
      "Type": "Task",
      "Resource": "arn:aws:lambda:${aws_region}:${aws_account_id}:function:hourstats-processor",
      "Parameters": {
        "runId.$": "$.OrchestratorOutput.runId",
        "analysisIntervalMinutes": 60
      },
      "ResultPath": "$.ProcessorOutput",
      "End": true
    }
  }
}